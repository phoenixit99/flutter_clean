# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Dart

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  pull_request_target:
    types: [closed]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
      - name: Download and setup Pactus daemon
        run: |
          # Create directory for pactus
          mkdir -p $HOME/.pactus
          
          # Download latest pactus-daemon release
          curl -L -o pactus-daemon.tar.gz $(curl -s https://api.github.com/repos/pactus-project/pactus/releases/latest | grep "browser_download_url.*linux-amd64.tar.gz" | cut -d '"' -f 4)
          
          # Extract the daemon
          tar xzf pactus-daemon.tar.gz
          
          # Move binary to path
          sudo mv pactus-daemon /usr/local/bin/
          
          # Make it executable
          sudo chmod +x /usr/local/bin/pactus-daemon
          
          # Verify installation
          pactus-daemon version

      - name: Start Pactus daemon
        run: |
          # Start daemon in background
          pactus-daemon start &
          # Wait for daemon to start
          sleep 10

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze project source
        run: flutter analyze


  # notify-on-merge:
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'pull_request_target' && github.event.pull_request.merged == true
    
  #   steps:
  #     - name: Send Telegram notification
  #       uses: appleboy/telegram-action@master
  #       with:
  #         to: ${{ secrets.TELEGRAM_CHAT_ID }}
  #         token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  #         format: markdown
  #         message: |
  #           ðŸŽ‰ *Pull Request Merged!*
            
  #           *PR Title:* ${{ github.event.pull_request.title }}
  #           *Merged by:* ${{ github.event.pull_request.merged_by.login }}
  #           *Repository:* ${{ github.repository }}
  #           *Branch:* ${{ github.event.pull_request.base.ref }}
            
  #           [View Pull Request](${{ github.event.pull_request.html_url }})
            
  #           *Changes Summary:*
  #           ```
  #           ${{ github.event.pull_request.body }}
  #           ```

  #     - name: Send Discord notification
  #       uses: Ilshidur/action-discord@master
  #       env:
  #         DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
  #       with:
  #         args: |
  #           ðŸŽ‰ **Pull Request Merged!**
            
  #           **PR Title:** ${{ github.event.pull_request.title }}
  #           **Merged by:** ${{ github.event.pull_request.merged_by.login }}
  #           **Repository:** ${{ github.repository }}
  #           **Branch:** ${{ github.event.pull_request.base.ref }}
            
  #           [View Pull Request](${{ github.event.pull_request.html_url }})
            
  #           **Changes Summary:**
  #           ```
  #           ${{ github.event.pull_request.body }}
  #           ```

      # Previous notification methods can be removed or kept as fallback
